name: üíø St2_Build-iStoreOS-ib (RK3566 OECT)

on:
  workflow_dispatch:
    inputs:
      openwrt_board:
        description: "ËÆæÂ§áÂûãÂè∑"
        required: true
        default: "wxy-oect"
        type: choice
        options:
          - wxy-oect
      openwrt_kernel:
        description: "ËØ∑ÈÄâÊã©ÂÜÖÊ†∏ÁâàÊú¨ÔºàÂÆòÊñπÊé®Ëçê 5.10.yÔºâ"
        required: true
        default: "5.10.y"
        type: choice
        options:
          - 5.10.y
      openwrt_rootfs:
        description: "ËØ∑ÈÄâÊã©RootfsÈÄöÁî®Â∫ïÂåÖÔºàÁ°Æ‰øùstep1ÊúâÁîüÊàêÔºâ"
        required: true
        default: "RELEASE"
        type: choice
        options:
          - RELEASE
      network_settings:
        description: "ËØ∑ÈÄâÊã©ÂàùÂßãÁΩëÁªúÈÖçÁΩÆÔºàÁ°Æ‰øùstep1ÊúâÁîüÊàêÔºâ"
        required: true
        default: "dhcp"
        type: choice
        options:
          - dhcp
          - static

env:
  VERSION: 24.10.3

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: ‚è¨ ‰∏ãËΩΩ rootfs.tar.gz
        run: |
          echo "üì¶ Ê≠£Âú®‰∏ãËΩΩÈ¢ÑÊûÑÂª∫ rootfs"
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/${{ github.actor }}/iStoreOS-Actions/releases/download/iStoreOS-${{ env.VERSION }}-${{ inputs.openwrt_rootfs }}-${{ inputs.network_settings }}/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: üîç Êü•Êâærootfs.tar.gzÊâÄÂú®Ë∑ØÂæÑ
        id: find_rootfs
        run: |
          ROOTFS_FILE=$(find bin/targets/armsr/armv8/ -type f -name "*rootfs.tar.gz" | head -n1)
          echo "‚úÖ Found: $ROOTFS_FILE"
          if [ ! -f "$ROOTFS_FILE" ]; then
            echo "‚ùå Êâæ‰∏çÂà∞ rootfs.tar.gz Êñá‰ª∂"
            exit 1
          fi
          echo "file=$ROOTFS_FILE" >> $GITHUB_OUTPUT

      - name: üß± ÊâìÂåÖiStoreOSÂõ∫‰ª∂ (RK3566 OECT)
        uses: ophub/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: ${{ steps.find_rootfs.outputs.file }}
          openwrt_board: ${{ inputs.openwrt_board }}
          openwrt_kernel: ${{ inputs.openwrt_kernel }}
          auto_kernel: true
          kernel_repo: ophub/kernel
          kernel_usage: stable
          builder_name: kwonelee

      - name: üìú Ë∞ÉÊï¥.img.gz Êñá‰ª∂Âêç
        id: rename
        run: |
          for FILE in ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz; do
            echo "Processing file: $FILE"
            FILENAME=$(basename "$FILE")
            NEW_FILENAME=$(echo "$FILENAME" | sed 's/openwrt/istoreos_${{ env.VERSION }}/g')
            if [ "$FILENAME" != "$NEW_FILENAME" ]; then
              mv "$FILE" "${{ env.PACKAGED_OUTPUTPATH }}/$NEW_FILENAME"
              echo "Renamed $FILENAME to $NEW_FILENAME"
            else
              echo "No need to rename $FILENAME"
            fi
          done

      - name: üöÄ ‰∏ä‰º†Âà∞ Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: iStoreOS-${{ env.VERSION }}-${{ inputs.openwrt_rootfs }}-${{ inputs.network_settings }}
          files: |
            ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
